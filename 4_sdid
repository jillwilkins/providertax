# Meta --------------------------------------------------------------------
## Author:        Jill Wilkins
## Date Created:  10/9/2025
## Date Edited:   10/14/2025
## Goal:          Event Study Analysis         
## 

library(fixest)
library(did)

# make mcrnum numeric
hospdata <- hospdata %>% mutate(mcrnum = as.numeric(mcrnum))

# Event Study for mcaid_prop
att_mcaid_prop <- att_gt(yname = "mcaid_prop",
                tname = "year",
                idname = "mcrnum",
                gname = "treatment_num",                  # year of tax, 0 if not yet treated by 2020, NA if always had a tax
                data = hospdata,
                control_group = "notyettreated",  
                xformla = ~ 1,                # covariates (use ~1 if none) ## what should i add here 
                est_method = "dr",            
                allow_unbalanced = TRUE
                )

summary(att_mcaid_prop)
ggdid(att_mcaid_prop)

overall_att_mcaid_prop <- aggte(att_mcaid_prop, type = "dynamic", na.rm = TRUE)
summary(overall_att_mcaid_prop)

# Overall Event Study Plot 
overall_mcaid_prop <- ggdid(overall_att_mcaid_prop)

# title 
overall_mcaid_prop <- overall_mcaid_prop +
  ggtitle("Event Study: Effect of Implementing Tax on Medicaid Proportion of Charges") +
  labs(
    x = "Years Relative to Treatment",
    y = "ATT (Average Treatment Effect on the Treated)"
  ) +
  theme_minimal()
ggsave("sumplots/events/overall_mcaid_prop.png", plot = overall_mcaid_prop, width = 8, height = 8, dpi = 300)
summary(hospdata$mcaid_prop)

table(hospdata$expyear, hospdata$treatment_num)
View(hospdata)
# Event Study for mcaid_prop_discharges
att_mcaid_prop_dis <- att_gt(yname = "mcaid_prop_discharges",
                tname = "year",
                idname = "mcrnum",
                gname = "treatment_num",                  # the column we created
                data = hospdata,
                control_group = "notyettreated",  # or "notyettreated"
                xformla = ~ beds,                # covariates (use ~1 if none)
                est_method = "dr",            # doubly-robust (optional)
                allow_unbalanced = TRUE
                )
summary(att_mcaid_prop_dis)
ggdid(att_mcaid_prop_dis)

overall_att_mcaid_prop_dis <- aggte(att_mcaid_prop_dis, type = "dynamic", na.rm = TRUE)
summary(overall_att_mcaid_prop_dis)
 
# overall event study plot & title 
overall_mcaid_prop_dis <- ggdid(overall_att_mcaid_prop_dis)
overall_mcaid_prop_dis <- overall_mcaid_prop_dis + 
  ggtitle("Event Study: Effect of Implementing Tax on Medicaid Proportion of Discharges") +
  labs(
    x = "Years Relative to Treatment",
    y = "ATT (Average Treatment Effect on the Treated)"
  ) + theme_minimal()
print(overall_mcaid_prop_dis)
ggsave("sumplots/events/overall_mcaid_prop_dis.png", plot = overall_mcaid_prop_dis, width = 8, height = 8, dpi = 300)

# medicaid discharges proportion pretty 
overall_med_dis_pretty <- overall_mcaid_prop_dis +
  ggtitle("Event Study: Effect of Implementing Tax on Medicaid Discharges") +
  labs(
    x = "Years Relative to Treatment",
    y = "ATT: Medicaid Proportion of Discharges"
  ) +
  theme_minimal(base_size = 14) +
  theme(
    plot.title = element_text(
      face = "bold",
      size = 16,
      hjust = 0.5,
      margin = margin(b = 10)
    ),
    axis.title.x = element_text(size = 13, margin = margin(t = 10)),
    axis.title.y = element_text(size = 13, margin = margin(r = 10)),
    axis.text = element_text(size = 11, color = "black"),
    panel.grid.major = element_line(color = "grey85", size = 0.3),
    panel.grid.minor = element_blank(),
    plot.background = element_rect(fill = "white", color = NA)
  ) +
  geom_hline(yintercept = 0, color = "black", linetype = "solid", size = 0.4)
print(overall_med_dis_pretty)
ggsave("sumplots/events/overall_med_dis_pretty.png", plot = overall_med_dis_pretty, width = 10, height = 8, dpi = 300)

# Event Study for ucc_prop
att_ucc_prop <- att_gt(yname = "ucc_prop",
                tname = "year",
                idname = "mcrnum",
                gname = "treatment_num",                  # the column we created
                data = hospdata,
                control_group = "notyettreated",  # or "notyettreated"
                xformla = ~ beds,                # covariates (use ~1 if none)
                est_method = "dr",            # doubly-robust (optional)
                allow_unbalanced = TRUE
                )
summary(att_ucc_prop)
ggdid(att_ucc_prop)

overall_att_ucc_prop <- aggte(att_ucc_prop, type = "dynamic", na.rm = TRUE)
summary(overall_att_ucc_prop)

# overall event study and title 
overall_ucc_prop <- ggdid(overall_att_ucc_prop)
overall_ucc_prop <- overall_ucc_prop + 
  ggtitle("Event Study: Effect of Implementing Tax on Uncompensated Care (% total charges)") +
  labs( 
    x = "Years Relative to Treatment",
    y = "ATT (Average Treatment Effect on the Treated)"
  ) + theme_minimal()
  print(overall_ucc_prop)
ggsave("sumplots/events/overall_ucc_prop.png", plot = overall_ucc_prop, width = 8, height = 8, dpi = 300)  
summary(hospdata$ucc_prop)


overall_ucc_pretty <- overall_ucc_prop +
  ggtitle("Event Study: Effect of Implementing Tax on Uncompensated Care Charges") +
  labs(
    x = "Years Relative to Treatment",
    y = "ATT: Uncompensated Care Charges to Total Charges"
  ) +
  scale_x_continuous(breaks = seq(2005, 2019, 2), limits = c(2005, 2019)) +
  theme_minimal(base_size = 14) +
  theme(
    plot.title = element_text(
      face = "bold",
      size = 16,
      hjust = 0.5,
      margin = margin(b = 10)
    ),
    axis.title.x = element_text(size = 13, margin = margin(t = 10)),
    axis.title.y = element_text(size = 13, margin = margin(r = 10)),
    axis.text = element_text(size = 11, color = "black"),
    panel.grid.major = element_line(color = "grey85", size = 0.3),
    panel.grid.minor = element_blank(),
    plot.background = element_rect(fill = "white", color = NA)
  ) +
  geom_hline(yintercept = 0, color = "black", linetype = "solid", size = 0.4)
print(overall_ucc_pretty)
ggsave("sumplots/events/overall_ucc_pretty.png", plot = overall_ucc_pretty, width = 10, height = 8, dpi = 300)

# Event study for cost to charge 
att_ccr <- att_gt(yname = "cost_to_charge",
                tname = "year",
                idname = "mcrnum",
                gname = "treatment_num",                  # the column we created
                data = hospdata_early,
                control_group = "notyettreated",  # or "notyettreated"
                xformla = ~ beds,                # covariates (use ~1 if none)
                est_method = "dr",    
                clustervars = "state",        # doubly-robust (optional)
                allow_unbalanced = TRUE
                )
                # cluster at the hospital level? 
summary(att_ccr)
ggdid(att_ccr)

overall_att_ccr <- aggte(att_ccr, type = "dynamic", na.rm = TRUE)
summary(overall_att_ccr)

# overall event study and title 
overall_ccr <- ggdid(overall_att_ccr)
overall_ccr <- overall_ccr + 
  ggtitle("Event Study: Effect of Implementing Tax on Cost to Charge Ratio") +
  labs( 
    x = "Years Relative to Treatment",
    y = "ATT (Average Treatment Effect on the Treated)"
  ) + theme_minimal()
ggsave("sumplots/events/overall_ccr.png", plot = overall_ccr, width = 8, height = 8, dpi = 300) 

# cost per charge pretty 
overall_ccr_pretty <- overall_ccr +
  ggtitle("Event Study: Effect of Implementing Tax on Cost to Charge Ratio") +
  labs(
    x = "Years Relative to Treatment",
    y = "ATT: Cost to Charge Ratio"
  ) +
  theme_minimal(base_size = 14) +
  theme(
    plot.title = element_text(
      face = "bold",
      size = 16,
      hjust = 0.5,
      margin = margin(b = 10)
    ),
    axis.title.x = element_text(size = 13, margin = margin(t = 10)),
    axis.title.y = element_text(size = 13, margin = margin(r = 10)),
    axis.text = element_text(size = 11, color = "black"),
    panel.grid.major = element_line(color = "grey85", size = 0.3),
    panel.grid.minor = element_blank(),
    plot.background = element_rect(fill = "white", color = NA)
  ) +
  geom_hline(yintercept = 0, color = "black", linetype = "solid", size = 0.4)
print(overall_ccr_pretty)
ggsave("sumplots/events/overall_ccr_pretty.png", plot = overall_ccr_pretty, width = 10, height = 8, dpi = 300)

# Event study for cost to discharge 
att_cpd <- att_gt(yname = "cost_per_discharge",
                tname = "year",
                idname = "mcrnum",
                gname = "treatment_num",                  # the column we created
                data = hospdata,
                control_group = "notyettreated",  # or "notyettreated"
                xformla = ~ 1,                # covariates (use ~1 if none)
                est_method = "dr",            # doubly-robust (optional)
                allow_unbalanced = TRUE
                )

overall_att_cpd<- aggte(att_cpd, type = "dynamic", na.rm = TRUE)
summary(overall_att_cpd)

# overall event study and title 
overall_cpd <- ggdid(overall_att_cpd)
overall_cpd <- overall_cpd + 
  ggtitle("Event Study: Effect of Implementing Tax on Cost per Discharge (calc)") +
  labs( 
    x = "Years Relative to Treatment",
    y = "ATT (Average Treatment Effect on the Treated)"
  ) + theme_minimal()
ggsave("sumplots/events/overall_cpd.png", plot = overall_cpd, width = 8, height = 8, dpi = 300) 

hospdata_early <- hospdata %>% filter(year < 2020)
# Event study for casemix 
att_ppd <- att_gt(yname = "private_prop_discharges",
                tname = "year",
                idname = "mcrnum",
                gname = "treatment_num",                  # the column we created
                data = hospdata_early,
                control_group = "nevertreated",  # or "notyettreated"
                xformla = ~ beds,               # covariates (use ~1 if none)
                est_method = "dr",            # doubly-robust (optional)
                allow_unbalanced = TRUE
                )

hospdata %>%
  group_by(year) %>%
  summarise(
    beds_var = var(beds, na.rm = TRUE),
    expyear_var = var(expyear, na.rm = TRUE)
  )

summary(att_ppd)
ggdid(att_ppd)
overall_att_ppd<- aggte(att_ppd, type = "dynamic", na.rm = TRUE)
summary(overall_att_ppd)

# overall event study and title 
overall_casemix <- ggdid(overall_att_ppd)
overall_casemix <- overall_casemix + 
  ggtitle("Event Study: Effect of Implementing Tax on Payer Mix") +
  labs( 
    x = "Years Relative to Treatment",
    y = "ATT: Non Public Proportion of Discharges"
  ) + theme_minimal()
print(overall_casemix)
overall_casemix_pretty <- overall_casemix +
  ggtitle("Event Study: Effect of Implementing Tax on Payer Mix") +
  labs(
    x = "Years Relative to Treatment",
    y = "ATT: Non-Public Proportion of Discharges"
  ) +
  theme_minimal(base_size = 14) +
  theme(
    plot.title = element_text(
      face = "bold",
      size = 16,
      hjust = 0.5,
      margin = margin(b = 10)
    ),
    axis.title.x = element_text(size = 13, margin = margin(t = 10)),
    axis.title.y = element_text(size = 13, margin = margin(r = 10)),
    axis.text = element_text(size = 11, color = "black"),
    panel.grid.major = element_line(color = "grey85", size = 0.3),
    panel.grid.minor = element_blank(),
    plot.background = element_rect(fill = "white", color = NA)
  ) +
  geom_hline(yintercept = 0, color = "black", linetype = "solid", size = 0.4)

print(overall_casemix_pretty)

ggsave("sumplots/events/overall_casemix_pretty.png", plot = overall_casemix_pretty, width = 10, height = 8, dpi = 300) 
summary(hospdata_clean$private_prop_discharges)


