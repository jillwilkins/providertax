# Meta --------------------------------------------------------------------
## Author:        Jill Wilkins
## Date Created:  10/9/2025
## Date Edited:   10//2025
## Goal:          Event Study Analysis         
## 

library(fixest)
library(did)

# make mcrnum numeric
hospdata <- hospdata %>% mutate(mcrnum = as.numeric(mcrnum))

# Event Study for mcaid_prop
att_mcaid_prop <- att_gt(yname = "mcaid_prop",
                tname = "year",
                idname = "mcrnum",
                gname = "treatment_num",                  # the column we created
                data = hospdata,
                control_group = "notyettreated",  # or "notyettreated"
                xformla = ~ 1,                # covariates (use ~1 if none)
                est_method = "dr",            # doubly-robust (optional)
                allow_unbalanced = TRUE
                )
summary(att_mcaid_prop)
ggdid(att_mcaid_prop)

overall_att_mcaid_prop <- aggte(att_mcaid_prop, type = "dynamic", na.rm = TRUE)
summary(overall_att_mcaid_prop)
overall_mcaid_prop <- ggdid(overall_att_mcaid_prop)
ggsave("sumplots/event/overall_mcaid_prop.png", plot = overall_mcaid_prop, width = 8, height = 8, dpi = 300)
summary(hospdata$mcaid_prop)

# Event Study for mcaid_prop_discharges
att_mcaid_prop_dis <- att_gt(yname = "mcaid_prop_discharges",
                tname = "year",
                idname = "mcrnum",
                gname = "treatment_num",                  # the column we created
                data = hospdata,
                control_group = "notyettreated",  # or "notyettreated"
                xformla = ~ 1,                # covariates (use ~1 if none)
                est_method = "dr",            # doubly-robust (optional)
                allow_unbalanced = TRUE
                )
summary(att_mcaid_prop_dis)
ggdid(att_mcaid_prop_dis)

overall_att_mcaid_prop_dis <- aggte(att_mcaid_prop_dis, type = "dynamic", na.rm = TRUE)
summary(overall_att_mcaid_prop_dis)
ggdid(overall_att_mcaid_prop_dis)
summary(hospdata$mcaid_prop_discharges)

# Event Study for ucc_prop
att_ucc_prop <- att_gt(yname = "ucc_prop",
                tname = "year",
                idname = "mcrnum",
                gname = "treatment_num",                  # the column we created
                data = hospdata,
                control_group = "notyettreated",  # or "notyettreated"
                xformla = ~ 1,                # covariates (use ~1 if none)
                est_method = "dr",            # doubly-robust (optional)
                allow_unbalanced = TRUE
                )
summary(att_ucc_prop)
ggdid(att_ucc_prop)

overall_att_ucc_prop <- aggte(att_ucc_prop, type = "dynamic", na.rm = TRUE)
summary(overall_att_ucc_prop)
ggdid(overall_att_ucc_prop)
summary(hospdata$ucc_prop)


